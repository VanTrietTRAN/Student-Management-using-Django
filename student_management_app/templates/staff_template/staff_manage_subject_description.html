{% extends 'staff_template/base_template.html' %}
{% block page_title %}
Quản lý Mô tả - {{ subject.subject_name }}
{% endblock page_title %}

{% block main_content %}
<section class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12">
                <!-- Breadcrumb -->
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="{% url 'staff_my_subjects' %}">Môn học của tôi</a></li>
                        <li class="breadcrumb-item active">{{ subject.subject_name }} - Mô tả & Tài liệu</li>
                    </ol>
                </nav>
                
                <div class="card card-primary">
                    <div class="card-header">
                        <h3 class="card-title"><i class="fas fa-book"></i> {{ subject.subject_name }} - Quản lý Mô tả & Tài liệu</h3>
                    </div>
                    <div class="card-body">
                        {% if messages %}
                        {% for message in messages %}
                        {% if message.tags == 'error' %}
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="close" data-dismiss="alert">
                                <span>&times;</span>
                            </button>
                        </div>
                        {% endif %}
                        {% if message.tags == 'success' %}
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            {{ message }}
                            <button type="button" class="close" data-dismiss="alert">
                                <span>&times;</span>
                            </button>
                        </div>
                        {% endif %}
                        {% endfor %}
                        {% endif %}
                        
                        <!-- Thông tin môn học -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <h5><i class="fas fa-info-circle text-info"></i> Thông tin môn học</h5>
                                <table class="table table-sm table-bordered">
                                    <tr>
                                        <th width="40%">Tên môn học</th>
                                        <td><strong>{{ subject.subject_name }}</strong></td>
                                    </tr>
                                    <tr>
                                        <th>Khóa học</th>
                                        <td>{{ subject.course_id.course_name }}</td>
                                    </tr>
                                    <tr>
                                        <th>Số tín chỉ</th>
                                        <td>{{ subject.credit_hours }}</td>
                                    </tr>
                                    <tr>
                                        <th>Học phí/tín chỉ</th>
                                        <td>{{ subject.fee_per_credit|floatformat:0|intcomma }} VNĐ</td>
                                    </tr>
                                </table>
                            </div>
                        </div>
                        
                        <!-- Quản lý Mô tả -->
                        <div class="row mb-4">
                            <div class="col-md-12">
                                <div class="card card-outline card-info">
                                    <div class="card-header">
                                        <h5 class="card-title"><i class="fas fa-align-left"></i> Mô tả môn học</h5>
                                        <div class="card-tools">
                                            <button type="button" class="btn btn-sm btn-primary" data-toggle="modal" data-target="#descModal">
                                                <i class="fas fa-edit"></i> Chỉnh sửa mô tả
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        {% if subject.description %}
                                            {{ subject.description|linebreaks }}
                                        {% else %}
                                            <p class="text-muted"><i>Chưa có mô tả. Nhấn nút "Chỉnh sửa mô tả" để thêm.</i></p>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Quản lý File PDF -->
                        <div class="row">
                            <div class="col-md-12">
                                <div class="card card-outline card-success">
                                    <div class="card-header">
                                        <h5 class="card-title"><i class="fas fa-file-pdf text-danger"></i> Tài liệu PDF ({{ description_files.count }} file(s))</h5>
                                        <div class="card-tools">
                                            <button type="button" class="btn btn-sm btn-success" data-toggle="modal" data-target="#uploadModal">
                                                <i class="fas fa-upload"></i> Upload PDF
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-body">
                                        {% if description_files %}
                                            <div class="table-responsive">
                                                <table class="table table-bordered table-hover">
                                                    <thead class="thead-light">
                                                        <tr>
                                                            <th width="50%">Tên file</th>
                                                            <th width="25%">Ngày upload</th>
                                                            <th width="25%">Thao tác</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for file in description_files %}
                                                        <tr>
                                                            <td>
                                                                <i class="fas fa-file-pdf text-danger fa-lg mr-2"></i>
                                                                <strong>{{ file.file_name }}</strong>
                                                            </td>
                                                            <td>
                                                                <i class="fas fa-calendar"></i> {{ file.uploaded_at|date:"d/m/Y H:i" }}
                                                            </td>
                                                            <td>
                                                                <a href="{{ file.file.url }}" target="_blank" class="btn btn-sm btn-primary">
                                                                    <i class="fas fa-eye"></i> Xem
                                                                </a>
                                                                <a href="{{ file.file.url }}" download class="btn btn-sm btn-success">
                                                                    <i class="fas fa-download"></i> Tải
                                                                </a>
                                                                <a href="{% url 'delete_subject_description' file.id %}" 
                                                                   class="btn btn-sm btn-danger"
                                                                   onclick="return confirm('Bạn có chắc muốn xóa file này?')">
                                                                    <i class="fas fa-trash"></i> Xóa
                                                                </a>
                                                            </td>
                                                        </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        {% else %}
                                            <div class="alert alert-warning">
                                                <i class="fas fa-exclamation-triangle"></i> Chưa có tài liệu PDF. Nhấn nút "Upload PDF" để thêm tài liệu.
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Modal Upload PDF -->
<div class="modal fade" id="uploadModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success">
                <h5 class="modal-title text-white"><i class="fas fa-upload"></i> Upload Tài liệu PDF</h5>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <form method="post" 
                  action="{% url 'upload_subject_description' subject.id %}" 
                  enctype="multipart/form-data" 
                  onsubmit="return validateUploadForm()">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> Giữ <strong>Ctrl</strong> để chọn nhiều file (tối đa 3 files, mỗi file tối đa 10MB)
                    </div>
                    <div class="form-group">
                        <label>Chọn file PDF</label>
                        <input type="file" 
                               name="subject_description_files" 
                               class="form-control-file" 
                               accept=".pdf" 
                               multiple 
                               required
                               id="pdfFiles">
                        <small class="form-text text-muted">Chỉ chấp nhận file PDF</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                        <i class="fas fa-times"></i> Hủy
                    </button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-upload"></i> Upload
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Chỉnh sửa mô tả -->
<div class="modal fade" id="descModal">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-info">
                <h5 class="modal-title text-white"><i class="fas fa-edit"></i> Chỉnh sửa Mô tả môn học</h5>
                <button type="button" class="close text-white" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <form method="post" action="{% url 'staff_save_description' %}">
                {% csrf_token %}
                <input type="hidden" name="subject_id" value="{{ subject.id }}">
                <div class="modal-body">
                    <div class="form-group">
                        <label>Mô tả môn học</label>
                        <textarea name="description" 
                                  class="form-control" 
                                  rows="10" 
                                  placeholder="Nhập mô tả chi tiết về môn học...">{{ subject.description }}</textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">
                        <i class="fas fa-times"></i> Hủy
                    </button>
                    <button type="submit" class="btn btn-info">
                        <i class="fas fa-save"></i> Lưu thay đổi
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function validateUploadForm() {
    const fileInput = document.getElementById('pdfFiles');
    const files = fileInput.files;
    
    if (files.length === 0) {
        alert('Vui lòng chọn ít nhất một file PDF');
        return false;
    }
    
    if (files.length > 3) {
        alert('Chỉ được upload tối đa 3 files');
        return false;
    }
    
    // Kiểm tra dung lượng file
    const maxSize = 10 * 1024 * 1024; // 10MB
    for (let i = 0; i < files.length; i++) {
        if (files[i].size > maxSize) {
            alert('File ' + files[i].name + ' vượt quá dung lượng cho phép (10MB)');
            return false;
        }
        
        // Kiểm tra extension
        const fileName = files[i].name;
        if (!fileName.toLowerCase().endsWith('.pdf')) {
            alert('Chỉ chấp nhận file PDF');
            return false;
        }
    }
    
    return true;
}
</script>
{% endblock main_content %}
