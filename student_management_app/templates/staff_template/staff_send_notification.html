{% extends 'staff_template/base_template.html' %}
{% load static %}
{% block page_title %}
Gửi thông báo
{% endblock page_title %}
{% block main_content %}
    <!-- Main content -->
    <section class="content">
      <div class="container-fluid">
          <div class="row">
              <div class="col-md-8 offset-md-2">
                  <div class="card card-primary">
                      <div class="card-header">
                          <h3 class="card-title">
                              <i class="fas fa-bell"></i> Gửi thông báo cho sinh viên
                          </h3>
                      </div>
                      
                      <form action="{% url 'staff_send_notification_save' %}" method="post">
                          {% csrf_token %}
                          <div class="card-body">
                              {% if messages %}
                                  {% for message in messages %}
                                  {% if message.tags == 'error' %}
                                  <div class="alert alert-danger alert-dismissible fade show">
                                      <button type="button" class="close" data-dismiss="alert">&times;</button>
                                      {{ message }}
                                  </div>
                                  {% endif %}
                                  {% if message.tags == 'success' %}
                                  <div class="alert alert-success alert-dismissible fade show">
                                      <button type="button" class="close" data-dismiss="alert">&times;</button>
                                      {{ message }}
                                  </div>
                                  {% endif %}
                                  {% endfor %}
                              {% endif %}

                              <div class="form-group">
                                  <label for="subject_id">Chọn môn học <span class="text-danger">*</span></label>
                                  <select class="form-control select2" id="subject_id" name="subject_id" required>
                                      <option value="">-- Chọn môn học --</option>
                                      {% for subject in subjects %}
                                      <option value="{{ subject.id }}">
                                          {{ subject.subject_code }} - {{ subject.subject_name }} ({{ subject.student_count }} sinh viên)
                                      </option>
                                      {% endfor %}
                                  </select>
                                  <small class="form-text text-muted">
                                      Thông báo sẽ được gửi đến tất cả sinh viên đăng ký môn học này
                                  </small>
                              </div>

                              <div class="form-group">
                                  <label for="message">Nội dung thông báo <span class="text-danger">*</span></label>
                                  <textarea class="form-control" 
                                            id="message" 
                                            name="message" 
                                            rows="8" 
                                            placeholder="Nhập nội dung thông báo..."
                                            required></textarea>
                                  <small class="form-text text-muted">
                                      Tối đa 500 ký tự
                                  </small>
                              </div>

                              <div class="form-group">
                                  <div class="custom-control custom-checkbox">
                                      <input type="checkbox" class="custom-control-input" id="confirm" required>
                                      <label class="custom-control-label" for="confirm">
                                          Tôi xác nhận nội dung thông báo chính xác và muốn gửi đến sinh viên
                                      </label>
                                  </div>
                              </div>

                              <!-- Preview Box -->
                              <div class="alert alert-info" id="preview" style="display: none;">
                                  <h5><i class="fas fa-eye"></i> Xem trước thông báo:</h5>
                                  <div id="preview-content"></div>
                              </div>
                          </div>
                          
                          <div class="card-footer">
                              <button type="button" class="btn btn-info" id="preview-btn">
                                  <i class="fas fa-eye"></i> Xem trước
                              </button>
                              <button type="submit" class="btn btn-success">
                                  <i class="fas fa-paper-plane"></i> Gửi thông báo
                              </button>
                              <a href="{% url 'staff_home' %}" class="btn btn-secondary">
                                  <i class="fas fa-times"></i> Hủy
                              </a>
                          </div>
                      </form>
                  </div>

                  <!-- Sent Notifications History -->
                  <div class="card card-outline card-info">
                      <div class="card-header">
                          <h3 class="card-title">
                              <i class="fas fa-history"></i> Lịch sử thông báo đã gửi
                          </h3>
                      </div>
                      <div class="card-body">
                          {% if notifications %}
                          <div class="timeline">
                              {% for notification in notifications %}
                              <div class="time-label">
                                  <span class="bg-info">{{ notification.created_at|date:"d/m/Y" }}</span>
                              </div>
                              <div>
                                  <i class="fas fa-bell bg-primary"></i>
                                  <div class="timeline-item">
                                      <span class="time">
                                          <i class="fas fa-clock"></i> {{ notification.created_at|date:"H:i" }}
                                      </span>
                                      <h3 class="timeline-header">
                                          <strong>{{ notification.subject_id.subject_name }}</strong>
                                      </h3>
                                      <div class="timeline-body">
                                          {{ notification.message }}
                                      </div>
                                  </div>
                              </div>
                              {% endfor %}
                          </div>
                          {% else %}
                          <p class="text-muted">Chưa có thông báo nào được gửi.</p>
                          {% endif %}
                      </div>
                  </div>
              </div>
          </div>
      </div>
    </section>
    
    <script>
    $(document).ready(function() {
        // Initialize Select2
        $('.select2').select2({
            theme: 'bootstrap4',
            width: '100%'
        });
        
        // Preview functionality
        $('#preview-btn').click(function() {
            var subjectText = $('#subject_id option:selected').text();
            var message = $('#message').val();
            
            if (!subjectText || subjectText === '-- Chọn môn học --' || !message) {
                alert('Vui lòng chọn môn học và nhập nội dung thông báo!');
                return;
            }
            
            var previewHtml = '<p><strong>Môn học:</strong> ' + subjectText + '</p>' +
                             '<p><strong>Nội dung:</strong></p>' +
                             '<p>' + message.replace(/\n/g, '<br>') + '</p>';
            
            $('#preview-content').html(previewHtml);
            $('#preview').slideDown();
        });
        
        // Character counter
        $('#message').on('input', function() {
            var length = $(this).val().length;
            var maxLength = 500;
            
            if (length > maxLength) {
                $(this).val($(this).val().substring(0, maxLength));
                length = maxLength;
            }
            
            var remaining = maxLength - length;
            $(this).next('.form-text').text('Còn lại: ' + remaining + ' / ' + maxLength + ' ký tự');
        });
        
        // Form validation
        $('form').on('submit', function(e) {
            if (!$('#confirm').is(':checked')) {
                alert('Vui lòng xác nhận trước khi gửi thông báo!');
                e.preventDefault();
                return false;
            }
            
            if (!confirm('Bạn có chắc chắn muốn gửi thông báo này đến sinh viên?')) {
                e.preventDefault();
                return false;
            }
        });
    });
    </script>
{% endblock main_content %}
