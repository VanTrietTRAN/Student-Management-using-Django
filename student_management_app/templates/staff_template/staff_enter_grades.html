{% extends 'staff_template/base_template.html' %}
{% load static %}
{% block page_title %}
Nhập điểm - {{ subject.subject_name }}
{% endblock page_title %}
{% block main_content %}
    <!-- Main content -->
    <section class="content">
      <div class="container-fluid">
          <div class="row">
              <div class="col-12">
                  <div class="card">
                      <div class="card-header">
                          <h3 class="card-title">
                              <i class="fas fa-pen"></i> Nhập điểm cho sinh viên
                          </h3>
                          <div class="card-tools">
                              <a href="{% url 'staff_view_class_students' subject.id %}" class="btn btn-info btn-sm">
                                  <i class="fas fa-users"></i> Xem danh sách
                              </a>
                              <a href="{% url 'staff_my_subjects' %}" class="btn btn-secondary btn-sm">
                                  <i class="fas fa-arrow-left"></i> Quay lại
                              </a>
                          </div>
                      </div>
                      
                      <form action="{% url 'staff_save_grades' %}" method="post">
                          {% csrf_token %}
                          <input type="hidden" name="subject_id" value="{{ subject.id }}">
                          
                          <div class="card-body">
                              <!-- Subject Info -->
                              <div class="alert alert-info">
                                  <h5><i class="icon fas fa-book"></i> {{ subject.subject_name }}</h5>
                                  <p class="mb-0">
                                      <strong>Mã môn:</strong> {{ subject.subject_code }} | 
                                      <strong>Tín chỉ:</strong> {{ subject.credit_hours }} | 
                                      <strong>Số sinh viên:</strong> {{ students|length }}
                                  </p>
                              </div>

                              {% if messages %}
                                  {% for message in messages %}
                                  {% if message.tags == 'error' %}
                                  <div class="alert alert-danger alert-dismissible fade show">
                                      <button type="button" class="close" data-dismiss="alert">&times;</button>
                                      {{ message }}
                                  </div>
                                  {% endif %}
                                  {% if message.tags == 'success' %}
                                  <div class="alert alert-success alert-dismissible fade show">
                                      <button type="button" class="close" data-dismiss="alert">&times;</button>
                                      {{ message }}
                                  </div>
                                  {% endif %}
                                  {% endfor %}
                              {% endif %}

                              <!-- Grading Instructions -->
                              <div class="row mb-3">
                                  <div class="col-md-12">
                                      <div class="callout callout-warning">
                                          <h5><i class="fas fa-info-circle"></i> Hướng dẫn chấm điểm:</h5>
                                          <ul class="mb-0">
                                              <li><strong>Điểm bài tập:</strong> Nhập điểm từ 0-40</li>
                                              <li><strong>Điểm thi:</strong> Nhập điểm từ 0-60</li>
                                              <li><strong>Tổng điểm:</strong> Được tính tự động (Điểm BT + Điểm thi)</li>
                                              <li><strong>Điểm chữ:</strong> A+ (≥95), A (85-94), B (70-84), C (55-69), D (40-54), F (<40)</li>
                                          </ul>
                                      </div>
                                  </div>
                              </div>

                              {% if students %}
                              <div class="table-responsive">
                                  <table class="table table-bordered table-hover">
                                      <thead class="thead-light">
                                          <tr>
                                              <th style="width: 5%">STT</th>
                                              <th style="width: 15%">Mã SV</th>
                                              <th style="width: 30%">Họ và tên</th>
                                              <th style="width: 15%">Điểm BT (0-40)</th>
                                              <th style="width: 15%">Điểm thi (0-60)</th>
                                              <th style="width: 10%">Tổng điểm</th>
                                              <th style="width: 10%">Điểm chữ</th>
                                          </tr>
                                      </thead>
                                      <tbody>
                                          {% for student in students %}
                                          <tr>
                                              <td>{{ forloop.counter }}</td>
                                              <td>
                                                  <span class="badge badge-primary">{{ student.admin.username }}</span>
                                                  <input type="hidden" name="student_id[]" value="{{ student.id }}">
                                              </td>
                                              <td><strong>{{ student.admin.first_name }} {{ student.admin.last_name }}</strong></td>
                                              <td>
                                                  <input type="number" 
                                                         class="form-control assignment-marks" 
                                                         name="assignment_marks_{{ student.id }}" 
                                                         value="{{ student.assignment_marks|default:'' }}"
                                                         min="0" 
                                                         max="40" 
                                                         step="0.1"
                                                         data-student="{{ student.id }}"
                                                         placeholder="0-40">
                                              </td>
                                              <td>
                                                  <input type="number" 
                                                         class="form-control exam-marks" 
                                                         name="exam_marks_{{ student.id }}" 
                                                         value="{{ student.exam_marks|default:'' }}"
                                                         min="0" 
                                                         max="60" 
                                                         step="0.1"
                                                         data-student="{{ student.id }}"
                                                         placeholder="0-60">
                                              </td>
                                              <td class="text-center">
                                                  <strong class="total-marks" data-student="{{ student.id }}">
                                                      {% if student.assignment_marks and student.exam_marks %}
                                                      {{ student.assignment_marks|add:student.exam_marks }}
                                                      {% else %}
                                                      -
                                                      {% endif %}
                                                  </strong>
                                              </td>
                                              <td class="text-center">
                                                  <span class="grade-badge" data-student="{{ student.id }}">
                                                      {% if student.assignment_marks and student.exam_marks %}
                                                          {% with total=student.assignment_marks|add:student.exam_marks %}
                                                              {% if total >= 95 %}
                                                                  <span class="badge badge-purple">A+</span>
                                                              {% elif total >= 85 %}
                                                                  <span class="badge badge-success">A</span>
                                                              {% elif total >= 70 %}
                                                                  <span class="badge badge-primary">B</span>
                                                              {% elif total >= 55 %}
                                                                  <span class="badge badge-warning">C</span>
                                                              {% elif total >= 40 %}
                                                                  <span class="badge badge-secondary">D</span>
                                                              {% else %}
                                                                  <span class="badge badge-danger">F</span>
                                                              {% endif %}
                                                          {% endwith %}
                                                      {% else %}
                                                      -
                                                      {% endif %}
                                                  </span>
                                              </td>
                                          </tr>
                                          {% endfor %}
                                      </tbody>
                                  </table>
                              </div>
                              {% else %}
                              <div class="alert alert-info">
                                  <i class="icon fas fa-info-circle"></i>
                                  Chưa có sinh viên nào đăng ký môn học này.
                              </div>
                              {% endif %}
                          </div>
                          
                          <div class="card-footer">
                              {% if students %}
                              <button type="submit" class="btn btn-success btn-lg">
                                  <i class="fas fa-save"></i> Lưu điểm
                              </button>
                              {% endif %}
                              <a href="{% url 'staff_my_subjects' %}" class="btn btn-secondary btn-lg">
                                  <i class="fas fa-times"></i> Hủy
                              </a>
                          </div>
                      </form>
                  </div>
              </div>
          </div>
      </div>
    </section>
    
    <style>
    .badge-purple {
        background-color: #6f42c1;
        color: white;
    }
    </style>
    
    <script>
    $(document).ready(function() {
        // Calculate total and grade when marks change
        $('.assignment-marks, .exam-marks').on('input', function() {
            var studentId = $(this).data('student');
            var assignmentMarks = parseFloat($('input[name="assignment_marks_' + studentId + '"]').val()) || 0;
            var examMarks = parseFloat($('input[name="exam_marks_' + studentId + '"]').val()) || 0;
            var total = assignmentMarks + examMarks;
            
            // Update total
            $('.total-marks[data-student="' + studentId + '"]').text(total.toFixed(1));
            
            // Update grade badge
            var gradeBadge = '';
            if (total >= 95) {
                gradeBadge = '<span class="badge badge-purple">A+</span>';
            } else if (total >= 85) {
                gradeBadge = '<span class="badge badge-success">A</span>';
            } else if (total >= 70) {
                gradeBadge = '<span class="badge badge-primary">B</span>';
            } else if (total >= 55) {
                gradeBadge = '<span class="badge badge-warning">C</span>';
            } else if (total >= 40) {
                gradeBadge = '<span class="badge badge-secondary">D</span>';
            } else {
                gradeBadge = '<span class="badge badge-danger">F</span>';
            }
            $('.grade-badge[data-student="' + studentId + '"]').html(gradeBadge);
        });
        
        // Validate marks on form submit
        $('form').on('submit', function(e) {
            var valid = true;
            $('.assignment-marks').each(function() {
                var val = parseFloat($(this).val());
                if ($(this).val() !== '' && (val < 0 || val > 40)) {
                    alert('Điểm bài tập phải từ 0 đến 40');
                    valid = false;
                    return false;
                }
            });
            $('.exam-marks').each(function() {
                var val = parseFloat($(this).val());
                if ($(this).val() !== '' && (val < 0 || val > 60)) {
                    alert('Điểm thi phải từ 0 đến 60');
                    valid = false;
                    return false;
                }
            });
            if (!valid) {
                e.preventDefault();
            }
        });
    });
    </script>
{% endblock main_content %}
