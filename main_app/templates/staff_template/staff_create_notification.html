{% extends 'main_app/base.html' %}
{% load static %}
{% block page_title %}{{page_title}}{% endblock page_title %}
{% block content %}
<section class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">{{page_title}}</h3>
                        <div class="card-tools">
                            <a href="{% url 'staff_view_notification' %}" class="btn btn-secondary btn-sm">
                                <i class="fas fa-arrow-left"></i> View Notifications
                            </a>
                        </div>
                    </div>
                    <form method="POST">
                        {% csrf_token %}
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="form-group">
                                        <label for="message">Notification Message</label>
                                        <textarea class="form-control" id="message" name="message" rows="5" 
                                                  placeholder="Enter your notification message here..." required></textarea>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="form-group">
                                        <label>Target Audience</label>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="target_type" id="targetAll" value="all">
                                            <label class="form-check-label" for="targetAll">
                                                All Students
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="target_type" id="targetCourse" value="course">
                                            <label class="form-check-label" for="targetCourse">
                                                Students in Specific Course
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="target_type" id="targetSpecific" value="specific">
                                            <label class="form-check-label" for="targetSpecific">
                                                Specific Students
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Course Selection -->
                            <div class="row" id="courseSelection" style="display: none;">
                                <div class="col-md-12">
                                    <div class="form-group">
                                        <label for="target_course">Select Course</label>
                                        <select class="form-control" id="target_course" name="target_course">
                                            <option value="">Choose Course</option>
                                            {% for course in courses %}
                                            <option value="{{ course.id }}">{{ course.name }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Specific Students Selection -->
                            <div class="row" id="specificStudents" style="display: none;">
                                <div class="col-md-12">
                                    <div class="form-group">
                                        <label>Select Students</label>
                                        <div class="row">
                                            {% for student in students %}
                                            <div class="col-md-6 col-lg-4">
                                                <div class="form-check">
                                                    <input class="form-check-input" type="checkbox" 
                                                           name="specific_students" 
                                                           value="{{ student.id }}" 
                                                           id="student{{ student.id }}">
                                                    <label class="form-check-label" for="student{{ student.id }}">
                                                        {{ student.admin.last_name }}, {{ student.admin.first_name }}
                                                        <small class="text-muted">({{ student.admin.email }})</small>
                                                    </label>
                                                </div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Preview Section -->
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="card card-info">
                                        <div class="card-header">
                                            <h3 class="card-title">Preview</h3>
                                        </div>
                                        <div class="card-body">
                                            <div id="previewContent">
                                                <p class="text-muted">Select target audience to see preview</p>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-paper-plane"></i> Send Notification
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="clearForm()">
                                <i class="fas fa-times"></i> Clear
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock content %}

{% block custom_js %}
<script>
$(document).ready(function() {
    // Handle target type change
    $('input[name="target_type"]').change(function() {
        const targetType = $(this).val();
        
        // Hide all sections
        $('#courseSelection').hide();
        $('#specificStudents').hide();
        
        // Show relevant section
        if (targetType === 'course') {
            $('#courseSelection').show();
        } else if (targetType === 'specific') {
            $('#specificStudents').show();
        }
        
        updatePreview();
    });
    
    // Update preview when message or target changes
    $('#message, input[name="target_type"], #target_course, input[name="specific_students"]').on('input change', function() {
        updatePreview();
    });
    
    function updatePreview() {
        const message = $('#message').val();
        const targetType = $('input[name="target_type"]:checked').val();
        let targetInfo = '';
        
        if (!message) {
            $('#previewContent').html('<p class="text-muted">Enter a message to see preview</p>');
            return;
        }
        
        if (targetType === 'all') {
            targetInfo = '<span class="badge badge-primary">All Students</span>';
        } else if (targetType === 'course') {
            const courseName = $('#target_course option:selected').text();
            if (courseName && courseName !== 'Choose Course') {
                targetInfo = '<span class="badge badge-info">Course: ' + courseName + '</span>';
            } else {
                targetInfo = '<span class="badge badge-warning">Please select a course</span>';
            }
        } else if (targetType === 'specific') {
            const selectedStudents = $('input[name="specific_students"]:checked').length;
            if (selectedStudents > 0) {
                targetInfo = '<span class="badge badge-success">' + selectedStudents + ' Selected Students</span>';
            } else {
                targetInfo = '<span class="badge badge-warning">Please select at least one student</span>';
            }
        } else {
            targetInfo = '<span class="badge badge-secondary">No target selected</span>';
        }
        
        $('#previewContent').html(`
            <div class="alert alert-info">
                <strong>Message:</strong><br>
                ${message.replace(/\n/g, '<br>')}
            </div>
            <div class="mt-2">
                <strong>Target:</strong> ${targetInfo}
            </div>
        `);
    }
    
    // Form validation
    $('form').submit(function(e) {
        const targetType = $('input[name="target_type"]:checked').val();
        
        if (!targetType) {
            e.preventDefault();
            alert('Please select a target audience');
            return false;
        }
        
        if (targetType === 'course' && !$('#target_course').val()) {
            e.preventDefault();
            alert('Please select a course');
            return false;
        }
        
        if (targetType === 'specific' && $('input[name="specific_students"]:checked').length === 0) {
            e.preventDefault();
            alert('Please select at least one student');
            return false;
        }
    });
});

function clearForm() {
    $('form')[0].reset();
    $('#courseSelection').hide();
    $('#specificStudents').hide();
    $('#previewContent').html('<p class="text-muted">Select target audience to see preview</p>');
}
</script>
{% endblock custom_js %}
